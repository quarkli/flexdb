<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--
@license
Copyright (c) 2016 Quark Li. All rights reserved.
This code may only be used under the MIT license.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../elements.html">
<link rel="import" href="../../include.html">

<dom-module id="flex-form">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
      paper-item.fancy {
        cursor: pointer;
        --paper-item-focused: {
          background: var(--paper-amber-500);
          font-weight: bold;
        };
        --paper-item-focused-before: {
          opacity: 0;
        };
      }
    </style>

    <template is="dom-repeat" items="{{data}}">
      <paper-material class="paper-form" elevation="2">
        <template is="dom-if" if="[[isObject(item.v)]]">
          <div class="item" path="{{item.p}}" key="{{item.k}}" value="{{item.v}}">
            <div class="header">
              <h4>{{item.k}}</h4>
              <span class="space"></span>
              <template is="dom-if" if="[[editMode]]">
                <paper-icon-button icon="add" alt="New" on-tap="editItem"></paper-icon-button>
                <paper-icon-button icon="clear" alt="Drop" on-tap="editItem"></paper-icon-button>
              </template>
              <paper-icon-button icon="expand-more" alt="More" on-tap="toggleChild"></paper-icon-button>
              <input type="hidden" name="path" value="{{item.p}}">
            </div>
          </div>
          <iron-collapse>
            <flex-form data="{{item.v}}" edit-mode="[[editMode]]" edit-proc="[[getEditProc()]]"></flex-form>
          </iron-collapse>
        </template>
        <template is="dom-if" if="[[!isObject(item.v)]]">
          <div class="item" path="{{item.p}}" key="{{item.k}}" value="{{item.v}}">
            <div class="header">
              <span>{{item.k}}</span>
              <span class="space"></span>
              <template is="dom-if" if="[[editMode]]">
                <paper-icon-button icon="clear" alt="Drop" on-tap="editItem"></paper-icon-button>
              </template>
            </div>
            <paper-input label="Default Value" value="{{item.v}}" on-change="editItem" readonly="[[editMode]]"></paper-input>
          </div>
        </template>
      </paper-material>
    </template>

    <paper-dialog id="addDialog" modal role="alertdialog">
      <h2>Add Item</h2>
      <paper-input label="New Item Name" value="{{newItemName}}"></paper-input>
      <div class="buttons">
        <paper-button dialog-confirm on-tap="addItem" disabled=[[!newItemName]]>Add SECTTION</paper-button>
        <paper-button dialog-dismiss on-tap="addItem" disabled=[[!newItemName]]>Add FIELD</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="dropDialog" modal role="alertdialog">
      <h2>Drop {{targetType}}</h2>
      <p>Drop "{{targetKey}}"?</p>
      <div class="buttons">
        <paper-button dialog-confirm on-tap="execEdit">Drop</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'flex-form',

        properties: {
          data: {
            type: Array,
            value: ()=>{return []},
            notify: true
          },
          editMode: {
            type: Boolean,
            value: false,
            notify: true
          },
          editTarget: {
            type: Object
          },
          targetAct: {
            type: String,
            value: ''
          },
          targetForm: {
            type: String,
            value: ''
          },
          targetType: {
            type: String,
            value: ''
          },
          targetPath: {
            type: String,
            value: ''
          },
          targetKey: {
            type: String,
            value: ''
          },
          targetValue: {
            type: String,
            value: ''
          },
          newItemName: {
            type: String,
            value: ''
          },
          editProc: {
            type: Function
          }
        },

        isObject: function(tgt) {
          return typeof tgt == 'object';
        },

        toggleChild: function() {
          var btn = Polymer.dom(event).localTarget;
          btn.icon = btn.icon.match('more') ? 'expand-less' : 'expand-more';
          var target = $(btn).parents('paper-material').children('iron-collapse').first()[0];
          target.toggle();
        },

        resetEdit: function() {
          this.editTarget = undefined;
          this.targetForm = undefined;
          this.targetPath = undefined;
          this.targetKey = undefined;
          this.targetValue = undefined;
          this.targetType = undefined;
          this.newItemName = '';
        },

        editItem: function(e) {
          this.resetEdit();
          var collap = $(e.target).parents('paper-material').first().find('iron-collapse')[0];
          if (collap && !collap.opened) collap.toggle();

          this.editTarget = $(e.target);
          this.targetForm = $(e.target).parents('paper-material[elevation=1]').find('h1').html()

          var tgt = $(e.target).parents('div.item')[0];
          if (tgt) {
            this.targetPath = tgt.path;
            this.targetKey = tgt.key;
            this.targetValue = tgt.value;
            this.targetType = 'FIELD';

            if ($(tgt).find('h4').length) {
              this.targetType = 'SECTION';
            }
          }

          if (e.target.tagName.toLowerCase() == 'input') {
            this.targetAct = 'UPDATE';
            this.execEdit();
          }
          else if ($(e.target).attr('alt') == 'Drop') {
            this.targetAct = 'DROP';
            this.$$('#dropDialog').toggle();
          }
          else {
            this.targetAct = 'ADD';
            this.$$('#addDialog').toggle();
          }
        },

        execEdit: function() {
          if (this.editProc) this.editProc(this.targetAct, this.targetType, this.targetForm, this.targetPath, this.targetKey, this.targetValue);
        },

        addItem: function(e) {
          this.targetType = $(e.target).justtext().trim().split(' ')[1];
          this.targetValue = $(e.target).parents('paper-dialog').find('paper-input')[0].value;
          this.execEdit();
        },

        getEditProc: function() {
          return this.editProc;
        }
      });
    })();
  </script>
</dom-module>
