<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--
@license
Copyright (c) 2016 Quark Li. All rights reserved.
This code may only be used under the MIT license.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../elements.html">
<link rel="import" href="../../include.html">

<dom-module id="flex-form">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }
    </style>

    <paper-material class="paper-form" elevation="1">
      <!-- header: form/sectioin name -->
      <div class="header">
        <template is="dom-if" if="{{isRoot}}">
          <h1>{{id}}</h1>
        </template>
        <template is="dom-if" if="{{!isRoot}}">
          <h4>{{id}}</h4>
        </template>
        <span class="space"></span>
        <template is="dom-if" if="{{!editMode}}">
        <template is="dom-if" if="{{isRoot}}">
          <paper-icon-button icon="create" alt="Edit" on-tap="editForm"></paper-icon-button>
          <paper-icon-button icon="clear" alt="Drop" on-tap="dropForm"></paper-icon-button>
        </template>
        </template>
        <template is="dom-if" if="{{editMode}}">
          <paper-icon-button icon="add" alt="New" on-tap="editItem"></paper-icon-button>
          <template is="dom-if" if="[[!isRoot]]">
            <paper-icon-button icon="clear" alt="Drop" on-tap="editItem"></paper-icon-button>
          </template>
          <template is="dom-if" if="[[data.length]]">
            <paper-icon-button icon="expand-more" alt="More" on-tap="toggleChild"></paper-icon-button>
          </template>
        </template>
      </div>

      <!-- data body -->
      <template is="dom-if" if="[[data.length]]">
        <iron-collapse>
          <template is="dom-repeat" items="{{data}}">
            <template is="dom-if" if="[[isObject(item.v)]]">
              <div class="section" path="{{item.p}}" key="{{item.k}}" value="{{item.v}}">
                <flex-form id="{{item.k}}" data="{{item.v}}" edit-mode="[[editMode]]"></flex-form>
              </div>
            </template>
            <template is="dom-if" if="[[!isObject(item.v)]]">
              <paper-material class="paper-form" elevation="1">
              <div class="field" path="{{item.p}}" key="{{item.k}}" value="{{item.v}}">
                <div class="header">
                  <span>{{item.k}}</span>
                  <span class="space"></span>
                  <template is="dom-if" if="[[editMode]]">
                    <paper-icon-button icon="clear" alt="Drop" on-tap="editItem"></paper-icon-button>
                  </template>
                </div>
                <paper-input label="Default Value" value="{{item.v}}" readonly="[[!editMode]]"></paper-input>
              </div>
              </paper-material>
            </template>
          </template>
        </iron-collapse>
      </template>

      <!-- FORM's JSON schema -->
      <template is="dom-if" if="{{isRoot}}">
      <template is="dom-if" if="{{!editMode}}">
        <pre>{{showSchema(data)}}</pre>
      </template>
      </template>
    </paper-material>

    <paper-dialog id="addDialog" modal role="alertdialog">
      <h2>Add Item</h2>
      <paper-input label="New Item Name" value="{{newItemName}}" maxlength="20"></paper-input>
      <div class="buttons">
        <paper-button dialog-confirm on-tap="addItem" disabled=[[!newItemName]]>Add SECTION</paper-button>
        <paper-button dialog-dismiss on-tap="addItem" disabled=[[!newItemName]]>Add FIELD</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="dropDialog" modal role="alertdialog">
      <h2>Drop {{targetType}}</h2>
      <p>Drop "{{targetKey}}"?</p>
      <div class="buttons">
        <paper-button dialog-confirm on-tap="dropItem">Drop</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'flex-form',

        properties: {
          data: {
            type: Array,
            value: ()=>{return []},
            notify: true
          },
          isRoot: {
            type: Boolean,
            value: false
          },
          editMode: {
            type: Boolean,
            value: false,
            notify: true
          },
          editTarget: {
            type: Object
          },
          targetAct: {
            type: String,
            value: ''
          },
          targetForm: {
            type: String,
            value: ''
          },
          targetType: {
            type: String,
            value: ''
          },
          targetPath: {
            type: String,
            value: ''
          },
          targetKey: {
            type: String,
            value: ''
          },
          targetValue: {
            type: String,
            value: ''
          },
          newItemName: {
            type: String,
            value: ''
          }
        },

        isObject: function(tgt) {
          return typeof tgt == 'object';
        },

        toggleChild: function(e) {
          var btn = e.target;
          btn.icon = btn.icon.match('more') ? 'expand-less' : 'expand-more';
          $(btn).parents('.paper-form').children('iron-collapse').first()[0].toggle();
        },

        dropForm: function(e) {
          this.targetType = 'FORM';
          this.targetKey = this.id;
          this.$$('#dropDialog').toggle();
        },

        editForm: function() {
          page(app.baseUrl+'form/' + this.id + '/edit');
        },

        resetEdit: function() {
          this.editTarget = undefined;
          this.targetForm = undefined;
          this.targetPath = undefined;
          this.targetKey = undefined;
          this.targetValue = undefined;
          this.targetType = undefined;
          this.newItemName = '';
        },

        editItem: function(e) {
          this.resetEdit();
          var collap = $(e.target).parents('paper-material').first().find('iron-collapse')[0];
          if (collap && !collap.opened) collap.toggle();

          this.editTarget = $(e.target);
          this.targetForm = $(e.target).parents('paper-material[elevation=1]').find('h1').html()

          var tgt = $(e.target).parents('div.field')[0];
          tgt = tgt || $(e.target).parents('div.section')[0];
          if (tgt) {
            this.targetPath = tgt.path;
            this.targetKey = tgt.key;
            this.targetValue = tgt.value;
            this.targetType = $(tgt).hasClass('field') ? 'FIELD' : 'SECTTION';
          }

          if ($(e.target).attr('alt') == 'Drop') {
            this.targetAct = 'DROP';
            this.$$('#dropDialog').toggle();
          }
          else if ($(e.target).attr('alt') == 'New') {
            this.targetAct = 'ADD';
            this.$$('#addDialog').toggle();
          }
        },

        dropItem: function() {
          var target = this;
          if (this.targetType == 'FORM') {
            target = $(this).parents('flex-forms').first()[0];
            var id = target.forms.findIndex(e=>{return e.name == this.id});
            if (id > -1) target.splice('forms', id, 1);

            flexModel.remove('table-schema/' + this.id);
          }
          else {
            if (Array.isArray(this.targetValue)) {
              target = $(this).parents('flex-form').first()[0];
            }
            var id = target.data.findIndex(e=>{return e.k == this.targetKey});
            if (id > -1) target.splice('data', id, 1);
          }
        },

        addItem: function(e) {
          this.targetType = $(e.target).justtext().trim().split(' ')[1];
          this.targetValue = $(e.target).parents('paper-dialog').find('paper-input')[0].value;
          this.push('data', {p: this.taregetPath ? this.targetPath : [], k: this.targetValue, v: this.targetType == 'SECTION' ? [] : ''});
          setTimeout(()=>{
            var collap = this.$$('iron-collapse');
            if (collap) collap.opened = true;
          }, 100);
        },

        showSchema: function(data) {
          return JSON.stringify(flexTools.array2json(data), null, 2);
        }
      });
    })();
  </script>
</dom-module>
