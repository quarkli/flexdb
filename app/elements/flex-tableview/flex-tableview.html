<!--
@license
Copyright (c) 2016 Quark Li. All rights reserved.
This code may only be used under the MIT license.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../elements.html">
<link rel="import" href="../../include.html">

<dom-module id="flex-tableview">
  <template>
    <style>
      :host {
        display: block;
      }
      span {
        @apply(--paper-font-body1);
      }
      .headerfield, td {
        text-align: right;
      }
      table.main {
        width: 100%;
      }
    </style>
    <paper-material elevation="1">
      <table class="main">
        <tr>
          <th>
            <paper-icon-button icon="menu"></paper-icon-button>
          </th>
          <template is="dom-repeat" items="[[data]]">
            <th>{{getIdx(index)}}</th>
          </template>
          <th>
            <paper-icon-button icon="add"></paper-icon-button>
          </th>
        </tr>
        <template is="dom-repeat" items="[[headerfields]]">
          <tr>
              <td class="headerfield">
                <a href="#" onclick="return false;">{{item.key}}</a>
              </td>
              <template is="dom-repeat" items="[[data]]" as="doc">
                <td>[[getField(doc, item)]]</td>
              </template>
              <td></td>
          </tr>
        </template>
      </table>
    </paper-material>

  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'flex-tableview',

        properties: {
          form: {
            type: Object,
            notify: true,
            observer: 'buildHeaders'
          },
          data: {
            type: Array,
            value: function(){return []},
            notify: true
          },
          headerfields: {
            type: Array,
            value: function(){return []},
            notify: true
          }
        },

        buildHeaders: function() {
          var me = this;
          var obj = flexTools.array2json(this.form.data);
          this.splice('headerfields', 0);
          flexTools.objectNodeIterator(obj, function(e, k, p, o){
            me.push('headerfields', {key: k, path: p, value: e});
          });
        },

        refreshData: function(data) {
          this.splice('data', 0);
          data.forEach(e=>{
            this.push('data', e);
          });
        },

        getIdx: function(id) {
          return id + 1;
        },

        getField: function(data, head) {
          var ret = undefined;
          flexTools.objectNodeIterator(data.data, function(e, k, p, o) {
            if (k == head.key  && JSON.stringify(p) == JSON.stringify(head.path)) {
              ret = e;
            }
          });
          return ret;
        },

        getRows: function(form) {
          var obj = flexTools.array2json(form.data);
          var rows = 0;
          flexTools.objectNodeIterator(obj, function(){rows++;});
          return rows + 1;
        }
      });
    })();
  </script>
</dom-module>
