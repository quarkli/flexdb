<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<!--
@license
Copyright (c) 2016 Quark Li. All rights reserved.
This code may only be used under the MIT license.
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../elements.html">
<link rel="import" href="../../include.html">

<dom-module id="flex-formpage">
  <template>
    <style>
      :host {
        display: block;
      }
      span {
        @apply(--paper-font-body1);
      }
      .paper-form {
        border-radius: 2px;
        height: 100%;
        padding: 16px;
        width: calc(98.66% - 16px);
        margin: 16px auto;
        background: var(--paper-indigo-50);
      }
      .paper-form div.header {
        @apply(--layout-horizontal);
        color: var(--secondary-text-color);
      }
      .paper-form span.space {
        @apply(--layout-flex);
      }
      .paper-form paper-icon-button {
        color: var(--accent-color);
      }
    </style>

    <template is="dom-repeat" items="{{forms}}">
      <paper-material class="paper-form" elevation="1">
        <div class="header">
          <h1>{{item.name}}</h1>
          <span class="space"></span>
          <paper-input type="hidden" value="{{item.editing}}"></paper-input>
          <template is="dom-if" if="{{!item.editing}}">
            <paper-icon-button icon="create" alt="Edit" on-tap="enableEdit"></paper-icon-button>
          </template>
          <template is="dom-if" if="{{item.editing}}">
            <paper-icon-button icon="add" alt="New" on-tap="addItem"></paper-icon-button>
            <paper-icon-button icon="clear" alt="Drop" on-tap="dropForm" hidden="[[newFormName]]"></paper-icon-button>
            <paper-icon-button icon="check" alt="Done" on-tap="enableEdit"></paper-icon-button>
          </template>
          <template is="dom-if" if="{{!item.editing}}">
          <template is="dom-if" if="[[item.data.length]]">
            <paper-icon-button icon="expand-more" alt="More" on-tap="toggleChild"></paper-icon-button>
          </template>
          </template>
        </div>
        <iron-collapse>
          <flex-form data="{{item.data}}" edit-proc="{{editProc()}}"></flex-form>
        </iron-collapse>
        <template is="dom-if" if="{{!item.editing}}">
          <pre>{{item.schema}}</pre>
        </template>
      </paper-material>
    </template>

    <paper-dialog id="dropDialog" modal role="alertdialog">
      <h2>Drop FORM</h2>
      <p>Drop "{{dropTarget}}"?</p>
      <div class="buttons">
        <paper-button dialog-confirm on-tap="execDropForm">Drop</paper-button>
        <paper-button dialog-dismiss>Cancel</paper-button>
      </div>
    </paper-dialog>

    <paper-dialog id="newDialog" modal role="alertdialog">
      <h2>New Form</h2>
      <paper-input label="Form Name" value="{{newFormName}}"></paper-input>
      <div class="buttons">
        <paper-button dialog-confirm on-tap="newForm" disabled="[[!newFormName]]">OK</paper-button>
      </div>
    </paper-dialog>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'flex-formpage',

        properties: {
          forms: {
            type: Array,
            value: ()=>{return []},
            notify: true
          },
          dropTarget: {
            type: String,
            notify: true
          },
          newFormName: {
            type: String,
            notify: true
          }
        },

        ready: function() {
        },

        enableEdit: function(e) {
          var editing = $(e.target).parents('.paper-form').find('paper-input[type=hidden]')[0];
          editing.value = !editing.value;
          $(e.target).parents('.paper-form').find('flex-form')[0].editMode = editing.value;
          var collap = $(e.target).parents('.paper-form').find('iron-collapse').first()[0];
          if (collap && !collap.opened) collap.toggle();
        },

        toggleChild: function() {
          var btn = Polymer.dom(event).localTarget;
          btn.icon = btn.icon.match('more') ? 'expand-less' : 'expand-more';
          var target = $(btn).parents('paper-material').children('iron-collapse').first()[0];
          target.toggle();
        },

        addItem: function(e) {
          var flxitem = $(e.target).parents('paper-material').find('flex-form')[0];
          flxitem.editItem(e);
        },

        dropForm: function(e) {
          var form = $(e.target).parents('div').children('h1').html();
          this.dropType = 'FORM';
          this.dropTarget = form;
          this.$$('#dropDialog').toggle();
        },

        execDropForm: function() {
          console.log('Drop Form: ' + this.dropTarget);
        },

        reset: function() {
          this.newFormName = undefined;
          this.splice('forms', 0, this.forms.length);
        },

        openNewFormDialog: function() {
          this.reset();
          this.$$('#newDialog').toggle();
        },

        newForm: function() {
          this.push('forms', {name: this.newFormName, data: [], schema: JSON.stringify({}, null, 2)});
        },

        editProc: function() {
          return function(act, type, form, path, key, value) {
            console.log(act, type, form, path, key, value);
          }
        }
      });
    })();
  </script>
</dom-module>
